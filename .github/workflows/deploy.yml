name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build backend
        run: npm run build
        working-directory: backend

      - name: Build frontend
        run: npm run build
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: https://family.thelodgegroup.id

      - name: Run backend tests (if available)
        run: npm test --if-present
        working-directory: backend

      - name: Create deployment package
        run: |
          mkdir -p deployment-package/backend deployment-package/frontend
          
          # Backend: copy build output, prisma, and package manifests
          cp -r backend/dist deployment-package/backend/dist
          cp -r backend/prisma deployment-package/backend/prisma
          cp backend/package.json deployment-package/backend/package.json
          cp backend/package-lock.json deployment-package/backend/package-lock.json || true

          # Frontend: copy build output and package manifests needed to run `next start`
          cp -r frontend/.next deployment-package/frontend/.next
          cp -r frontend/public deployment-package/frontend/public || true
          cp frontend/package.json deployment-package/frontend/package.json
          cp frontend/package-lock.json deployment-package/frontend/package-lock.json || true
          cp frontend/next.config.ts deployment-package/frontend/next.config.ts || true

          # Copy deployment scripts (optional utilities)
          mkdir -p deployment-package/scripts
          cp -r scripts/*.sh deployment-package/scripts/ 2>/dev/null || true

          # Copy nginx config if present in repo root
          if [ -f nginx-family-domain-fixed.conf ]; then
            cp nginx-family-domain-fixed.conf deployment-package/
          fi

          # Create deployment info
          echo "DEPLOYMENT_DATE=$(date)" > deployment-package/deployment-info.txt
          echo "COMMIT_SHA=${{ github.sha }}" >> deployment-package/deployment-info.txt
          echo "BRANCH=${{ github.ref_name }}" >> deployment-package/deployment-info.txt

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package/
          retention-days: 7

  deploy-to-vps:
    name: Deploy to VPS
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Validate required secrets
        run: |
          VPS_HOST="${{ secrets.VPS_HOST }}"
          VPS_USER="${{ secrets.VPS_USER }}"
          VPS_SSH_KEY_PRESENT="${{ secrets.VPS_SSH_KEY }}"
          DATABASE_URL_PRESENT="${{ secrets.DATABASE_URL }}"
          MISSING=""
          [ -z "$VPS_HOST" ] && MISSING="VPS_HOST $MISSING"
          [ -z "$VPS_USER" ] && MISSING="VPS_USER $MISSING"
          [ -z "$VPS_SSH_KEY_PRESENT" ] && MISSING="VPS_SSH_KEY $MISSING"
          [ -z "$DATABASE_URL_PRESENT" ] && MISSING="DATABASE_URL $MISSING"
          if [ -n "$MISSING" ]; then
            echo "Missing required secrets: $MISSING"
            exit 1
          else
            echo "All required secrets are present."
          fi

      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: deployment-package/

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          # Create deployment directory with timestamp
          DEPLOY_DIR="/var/www/lodge-family-$(date +%Y%m%d-%H%M%S)"

          # Create directory on VPS
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "sudo mkdir -p $DEPLOY_DIR && sudo chown -R ${{ secrets.VPS_USER }}:${{ secrets.VPS_USER }} $DEPLOY_DIR"

          # Upload deployment package
          scp -r deployment-package/* ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$DEPLOY_DIR/

          # Run deployment steps on VPS (expand DEPLOY_DIR locally into remote script)
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
            set -e
            
            # Ensure Node.js 20 and npm are installed (Ubuntu/Debian)
            if ! command -v node >/dev/null 2>&1; then
              echo "Node.js not found, installing Node.js 20 via NodeSource..."
              if command -v apt-get >/dev/null 2>&1; then
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                sudo apt-get update -y
                sudo apt-get install -y nodejs
              else
                echo "apt-get not available; please install Node.js 20 manually" && exit 1
              fi
            fi
            cd $DEPLOY_DIR

            # Debug Node.js environment
            echo "Node version: $(node -v || echo not found)"
            echo "NPM version: $(npm -v || echo not found)"
            echo "Node path: $(which node || echo not found)"
            echo "NPM path: $(which npm || echo not found)"

            # Export environment from GitHub Secrets for pre-service commands (Prisma, npm)
            export NODE_ENV=production
            export PORT=5001
            export DATABASE_URL='${{ secrets.DATABASE_URL }}'
            export JWT_SECRET='${{ secrets.JWT_SECRET }}'
            export FRONTEND_URL='${{ secrets.FRONTEND_URL }}'
            export ADMIN_EMAIL='${{ secrets.ADMIN_EMAIL }}'
            export ADMIN_PASSWORD='${{ secrets.ADMIN_PASSWORD }}'
            if [ -z "$DATABASE_URL" ]; then
              echo "Warning: DATABASE_URL is not set; Prisma migrate will fail" >&2
            fi

            # Install backend deps and run prisma
            cd backend
            npm ci --omit=dev || npm install --production
            npx prisma generate
            npx prisma migrate deploy || echo "Prisma migrate failed, please verify DATABASE_URL and migrations" 

            # Install frontend deps
            cd ../frontend
            npm ci --omit=dev || npm install --production

            # Stop existing services if running
            sudo systemctl stop lodge-family-backend || true
            sudo systemctl stop lodge-family-frontend || true

            # Ensure permissions for deployment directory
            sudo chown -R www-data:www-data $DEPLOY_DIR

            # Update symlink to current
            sudo rm -f /var/www/lodge-family-current
            sudo ln -s $DEPLOY_DIR /var/www/lodge-family-current

            # Create/Update systemd service units dynamically
            # Write environment file for backend from GitHub Secrets (if provided)
            sudo mkdir -p /etc/lodge-family
            printf "%s\n" \
            "NODE_ENV=production" \
            "PORT=5001" \
            "DATABASE_URL=${{ secrets.DATABASE_URL }}" \
            "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" \
            "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" \
            "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" \
            | sudo tee /etc/lodge-family/backend.env > /dev/null
            sudo chmod 640 /etc/lodge-family/backend.env
            sudo chown root:www-data /etc/lodge-family/backend.env

            sudo tee /etc/systemd/system/lodge-family-backend.service > /dev/null << 'UNIT'
            [Unit]
            Description=Lodge Family Backend Service
            After=network.target

            [Service]
            Type=simple
            WorkingDirectory=/var/www/lodge-family-current/backend
            ExecStart=/usr/bin/env node /var/www/lodge-family-current/backend/dist/index.js
            EnvironmentFile=/etc/lodge-family/backend.env
            Environment=PATH=/usr/local/bin:/usr/bin
            Restart=always
            RestartSec=10
            User=www-data

            [Install]
            WantedBy=multi-user.target
            UNIT

            sudo tee /etc/systemd/system/lodge-family-frontend.service > /dev/null << 'UNIT'
            [Unit]
            Description=Lodge Family Frontend Service
            After=network.target

            [Service]
            Type=simple
            WorkingDirectory=/var/www/lodge-family-current/frontend
            ExecStart=/usr/bin/env bash -lc 'npm run start --prefix /var/www/lodge-family-current/frontend'
            Environment=NODE_ENV=production
            Environment=PATH=/usr/local/bin:/usr/bin
            Restart=always
            RestartSec=10
            User=www-data

            [Install]
            WantedBy=multi-user.target
            UNIT

            # Reload and start services
            sudo systemctl daemon-reload
            sudo systemctl enable lodge-family-backend
            sudo systemctl enable lodge-family-frontend
            sudo systemctl start lodge-family-backend
            sudo systemctl start lodge-family-frontend

            # Install nginx config if package included and reload
            if [ -f "$DEPLOY_DIR/nginx-family-domain-fixed.conf" ]; then
              sudo cp "$DEPLOY_DIR/nginx-family-domain-fixed.conf" /etc/nginx/sites-available/lodge-family
              sudo ln -sf /etc/nginx/sites-available/lodge-family /etc/nginx/sites-enabled/lodge-family
            fi
            if sudo nginx -t; then
              sudo systemctl reload nginx || true
            fi

            # Cleanup old deployments (keep last 3)
            cd /var/www
            ls -dt lodge-family-* | tail -n +4 | xargs sudo rm -rf || true
            EOF

      - name: Health Check
        run: |
          # Initial wait for services to start
          sleep 20
          
          # Check if services are running
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "Checking service status..."
            sudo systemctl status lodge-family-backend --no-pager
            sudo systemctl status lodge-family-frontend --no-pager
            
            echo "Checking if application responds..."
            # Retry backend health up to 12 times (2 minutes)
            for i in $(seq 1 12); do
              if curl -fsS http://localhost:5001/api/health; then
                echo "Backend healthy"
                break
              fi
              echo "Backend not ready yet, retry $i/12..."
              sleep 10
              if [ "$i" -eq 12 ]; then
                echo "Backend failed to become healthy in time" && exit 1
              fi
            done

            # Retry frontend health up to 12 times (2 minutes)
            for i in $(seq 1 12); do
              if curl -fsS http://localhost:3003/; then
                echo "Frontend healthy"
                break
              fi
              echo "Frontend not ready yet, retry $i/12..."
              sleep 10
              if [ "$i" -eq 12 ]; then
                echo "Frontend failed to become healthy in time" && exit 1
              fi
            done
          EOF

          # External health check against public URL if provided
          if [ -n "${{ secrets.FRONTEND_URL }}" ]; then
            echo "Performing external health checks on ${{ secrets.FRONTEND_URL }}"
            # Retry public frontend homepage
            for i in $(seq 1 12); do
              if curl -fsS "${{ secrets.FRONTEND_URL }}"; then
                echo "Public frontend healthy"
                break
              fi
              echo "Public frontend not ready yet, retry $i/12..."
              sleep 10
              if [ "$i" -eq 12 ]; then
                echo "Public frontend failed to become healthy in time" && exit 1
              fi
            done

            # Retry public backend health endpoint
            for i in $(seq 1 12); do
              if curl -fsS "${{ secrets.FRONTEND_URL }}"/api/health; then
                echo "Public backend health healthy"
                break
              fi
              echo "Public backend health not ready yet, retry $i/12..."
              sleep 10
              if [ "$i" -eq 12 ]; then
                echo "Public backend health failed to become healthy in time" && exit 1
              fi
            done
          else
            echo "FRONTEND_URL secret not set; skipping external checks"
          fi

      - name: Rollback on failure
        if: failure()
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "Deployment failed, rolling back..."
            
            # Find previous deployment
            PREV_DEPLOY=$(ls -dt /var/www/lodge-family-* | sed -n '2p')
            
            if [ -n "$PREV_DEPLOY" ]; then
              sudo rm -f /var/www/lodge-family-current
              sudo ln -s $PREV_DEPLOY /var/www/lodge-family-current
              sudo systemctl restart lodge-family-backend
              sudo systemctl restart lodge-family-frontend
              echo "Rolled back to: $PREV_DEPLOY"
            else
              echo "No previous deployment found for rollback"
            fi
          EOF

  notify:
    name: Notify Deployment Status
    needs: [build-and-test, deploy-to-vps]
    runs-on: ubuntu-latest
    if: always()
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
    
    steps:
      - name: Notify Success
        if: needs.deploy-to-vps.result == 'success'
        run: |
          echo "✅ Deployment successful!"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Deployed at: $(date)"

          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "Sending Slack success notification"
            payload=$(cat <<'JSON'
            {
              "text": "✅ Deployment successful",
              "blocks": [
                {"type": "section", "text": {"type": "mrkdwn", "text": "*Deployment Status*: ✅ Successful"}},
                {"type": "section", "fields": [
                  {"type": "mrkdwn", "text": "*Commit*\n${{ github.sha }}"},
                  {"type": "mrkdwn", "text": "*Branch*\n${{ github.ref_name }}"},
                  {"type": "mrkdwn", "text": "*Frontend*\n${{ secrets.FRONTEND_URL }}"}
                ]},
                {"type": "context", "elements": [{"type": "mrkdwn", "text": "Deployed at $(date)"}]}
              ]
            }
            JSON
            )
            curl -fsS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL" || echo "Slack notify failed"
          else
            echo "SLACK_WEBHOOK_URL not set; skipping Slack notification"
          fi

      - name: Notify Failure
        if: needs.deploy-to-vps.result == 'failure'
        run: |
          echo "❌ Deployment failed!"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Failed at: $(date)"

          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "Sending Slack failure notification"
            payload=$(cat <<'JSON'
            {
              "text": "❌ Deployment failed",
              "blocks": [
                {"type": "section", "text": {"type": "mrkdwn", "text": "*Deployment Status*: ❌ Failed"}},
                {"type": "section", "fields": [
                  {"type": "mrkdwn", "text": "*Commit*\n${{ github.sha }}"},
                  {"type": "mrkdwn", "text": "*Branch*\n${{ github.ref_name }}"},
                  {"type": "mrkdwn", "text": "*Frontend*\n${{ secrets.FRONTEND_URL }}"}
                ]},
                {"type": "context", "elements": [{"type": "mrkdwn", "text": "Failed at $(date)"}]}
              ]
            }
            JSON
            )
            curl -fsS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL" || echo "Slack notify failed"
          else
            echo "SLACK_WEBHOOK_URL not set; skipping Slack notification"
          fi
